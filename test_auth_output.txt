
> @brainbox/extension@3.0.1 test:auth /home/stefanov/Projects/Chat Organizer Cursor/apps/extension
> vitest --run src/background/modules/__tests__/authManager.test.ts


 RUN  v3.2.4 /home/stefanov/Projects/Chat Organizer Cursor/apps/extension

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > initialize() > should register all network listeners
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > initialize() > should load tokens from storage on init
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > ChatGPT Token Capture > should capture Bearer token from Authorization header
[AuthManager] âœ… ChatGPT token updated 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > ChatGPT Token Capture > should capture Bearer token from Authorization header
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > ChatGPT Token Capture > should ignore non-Bearer tokens
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Claude Org ID Capture > should extract org ID from API URL
[AuthManager] âœ… Claude Org ID updated a1b2c3d4-e5f6-7890-abcd-ef1234567890

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Claude Org ID Capture > should extract org ID from API URL
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Claude Org ID Capture > should handle invalid URLs gracefully
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Gemini Dynamic Key Capture > should extract dynamic key from batchexecute request
[AuthManager] âœ… Gemini Dynamic Key updated 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Gemini Dynamic Key Capture > should extract dynamic key from batchexecute request
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Gemini Dynamic Key Capture > should handle various key formats (5-6 chars)
[AuthManager] âœ… Gemini Dynamic Key updated 
[AuthManager] âœ… Gemini Dynamic Key updated 
[AuthManager] âœ… Gemini Dynamic Key updated 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Gemini Dynamic Key Capture > should handle various key formats (5-6 chars)
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Gemini Dynamic Key Capture > should ignore non-batchexecute URLs
[AuthManager] ğŸ›¡ï¸ Initialized and listening. 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Dashboard Session > should store session tokens correctly
[AuthManager] ğŸ“¥ Processing session sync... {
  access_token: [32m'Missing'[39m,
  refresh_token: [32m'Missing'[39m,
  expires_at: [90mundefined[39m,
  user: [90mundefined[39m
}
[AuthManager] ğŸ’¾ Storing session in chrome.storage.local...

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Dashboard Session > should store session tokens correctly
[AuthManager] âœ… Session stored and verified successfully
[AuthManager] âœ… Dashboard session updated 
[AuthManager] â° Scheduled proactive refresh in 55 minutes 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > syncAll() > should verify dashboard token with API ping
[AuthManager] ğŸ”„ Starting full token sync... 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > syncAll() > should cleanup on 401 response
[AuthManager] ğŸ”„ Starting full token sync... 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > syncAll() > should handle network errors gracefully
[AuthManager] ğŸ”„ Starting full token sync... 

stderr | src/background/modules/__tests__/authManager.test.ts > AuthManager > syncAll() > should handle network errors gracefully
[AuthManager] ğŸš¨ Sync ping failed Error: Network error
    at [90m/home/stefanov/Projects/Chat Organizer Cursor/apps/extension/[39msrc/background/modules/__tests__/authManager.test.ts:335:48
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Auth Lifecycle Stress Tests > Handshake Test: should accept tokens from Dashboard origin via message
[AuthManager] ğŸ“¥ Processing session sync... {
  access_token: [32m'Missing'[39m,
  refresh_token: [32m'Missing'[39m,
  expires_at: [90mundefined[39m,
  user: [90mundefined[39m
}
[AuthManager] ğŸ’¾ Storing session in chrome.storage.local...

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Auth Lifecycle Stress Tests > Handshake Test: should accept tokens from Dashboard origin via message
[AuthManager] âœ… Session stored and verified successfully
[AuthManager] âœ… Dashboard session updated 
[AuthManager] â° Scheduled proactive refresh in 55 minutes 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Auth Lifecycle Stress Tests > Handshake Test: should accept tokens from Dashboard origin via message
[AuthManager] âœ… Session is valid by BRAINBOX_SESSION { expires_at: [33m1770769083698[39m, now: [33m1770765483698[39m }

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Auth Lifecycle Stress Tests > Persistence Test: should restore state after simulated restart
[AuthManager] ğŸ”„ Starting full token sync... 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Auth Lifecycle Stress Tests > Refresh Test: should report invalid session and cleanup on 401 (Simulated Refresh)
[AuthManager] ğŸ”„ Starting full token sync... 

stdout | src/background/modules/__tests__/authManager.test.ts > AuthManager > Auth Lifecycle Stress Tests > Refresh Test: should trust storage if fetch fails but token not expired (Offline mode)
[AuthManager] ğŸ”„ Starting full token sync... 

stderr | src/background/modules/__tests__/authManager.test.ts > AuthManager > Auth Lifecycle Stress Tests > Refresh Test: should trust storage if fetch fails but token not expired (Offline mode)
[AuthManager] ğŸš¨ Sync ping failed Error: No internet
    at [90m/home/stefanov/Projects/Chat Organizer Cursor/apps/extension/[39msrc/background/modules/__tests__/authManager.test.ts:420:50
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

 â¯ src/background/modules/__tests__/authManager.test.ts (23 tests | 2 failed) 28ms
   âœ“ AuthManager > initialize() > should register all network listeners 2ms
   âœ“ AuthManager > initialize() > should load tokens from storage on init 1ms
   âœ“ AuthManager > ChatGPT Token Capture > should capture Bearer token from Authorization header 1ms
   âœ“ AuthManager > ChatGPT Token Capture > should ignore non-Bearer tokens 0ms
   âœ“ AuthManager > ChatGPT Token Capture > should not update if token is the same 0ms
   âœ“ AuthManager > Claude Org ID Capture > should extract org ID from API URL 1ms
   âœ“ AuthManager > Claude Org ID Capture > should handle invalid URLs gracefully 0ms
   âœ“ AuthManager > Claude Org ID Capture > should not update if org ID is the same 0ms
   âœ“ AuthManager > Gemini Dynamic Key Capture > should extract dynamic key from batchexecute request 1ms
   âœ“ AuthManager > Gemini Dynamic Key Capture > should handle various key formats (5-6 chars) 1ms
   âœ“ AuthManager > Gemini Dynamic Key Capture > should ignore non-batchexecute URLs 0ms
   Ã— AuthManager > Dashboard Session > should store session tokens correctly 4ms
     â†’ expected undefined to be true // Object.is equality
   âœ“ AuthManager > Dashboard Session > should validate valid session 0ms
   âœ“ AuthManager > Dashboard Session > should reject expired session 0ms
   âœ“ AuthManager > Dashboard Session > should reject missing token 0ms
   âœ“ AuthManager > Dashboard Session > should accept session without expiry 0ms
   âœ“ AuthManager > syncAll() > should verify dashboard token with API ping 6ms
   Ã— AuthManager > syncAll() > should cleanup on 401 response 3ms
     â†’ expected "spy" to be called with arguments: [ [ 'accessToken', â€¦(3) ] ][90m

Received: 

[1m  1st spy call:

[22m[33m@@ -1,7 +1,8 @@[90m
[2m  [[22m
[2m    [[22m
[31m+     "BRAINBOX_SESSION",[90m
[2m      "accessToken",[22m
[2m      "refreshToken",[22m
[2m      "userEmail",[22m
[2m      "expiresAt",[22m
[2m    ],[22m
[39m[90m

Number of calls: [1m1[22m
[39m
   âœ“ AuthManager > syncAll() > should handle network errors gracefully 1ms
   âœ“ AuthManager > Auth Lifecycle Stress Tests > Handshake Test: should accept tokens from Dashboard origin via message 1ms
   âœ“ AuthManager > Auth Lifecycle Stress Tests > Persistence Test: should restore state after simulated restart 0ms
   âœ“ AuthManager > Auth Lifecycle Stress Tests > Refresh Test: should report invalid session and cleanup on 401 (Simulated Refresh) 1ms
   âœ“ AuthManager > Auth Lifecycle Stress Tests > Refresh Test: should trust storage if fetch fails but token not expired (Offline mode) 1ms

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  src/background/modules/__tests__/authManager.test.ts > AuthManager > Dashboard Session > should store session tokens correctly
AssertionError: expected undefined to be true // Object.is equality

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

 â¯ src/background/modules/__tests__/authManager.test.ts:238:34
    236|       expect(storage.refreshToken).toBe(session.refreshToken);
    237|       expect(storage.expiresAt).toBe(session.expiresAt);
    238|       expect(storage.rememberMe).toBe(true);
       |                                  ^
    239|     });
    240| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  src/background/modules/__tests__/authManager.test.ts > AuthManager > syncAll() > should cleanup on 401 response
AssertionError: expected "spy" to be called with arguments: [ [ 'accessToken', â€¦(3) ] ][90m

Received: 

[1m  1st spy call:

[22m[33m@@ -1,7 +1,8 @@[90m
[2m  [[22m
[2m    [[22m
[31m+     "BRAINBOX_SESSION",[90m
[2m      "accessToken",[22m
[2m      "refreshToken",[22m
[2m      "userEmail",[22m
[2m      "expiresAt",[22m
[2m    ],[22m
[39m[90m

Number of calls: [1m1[22m
[39m
 â¯ src/background/modules/__tests__/authManager.test.ts:321:43
    319| 
    320|       expect(result.isValid).toBe(false);
    321|       expect(chrome.storage.local.remove).toHaveBeenCalledWith([
       |                                           ^
    322|         'accessToken',
    323|         'refreshToken',

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed | 21 passed (23)
   Start at  01:18:02
   Duration  894ms (transform 78ms, setup 35ms, collect 46ms, tests 28ms, environment 341ms, prepare 182ms)

/home/stefanov/Projects/Chat Organizer Cursor/apps/extension:
â€‰ERR_PNPM_RECURSIVE_RUN_FIRST_FAILâ€‰ @brainbox/extension@3.0.1 test:auth: `vitest --run src/background/modules/__tests__/authManager.test.ts`
Exit status 1
