# quizhack_phase1_workflow.yml
# QuizHack Phase 1: Authentication & Setup Workflow
# Generated by Superior Meta-Architect+

version: "1.0"
name: "QuizHack Phase 1 - Authentication & Setup"
description: "Complete Supabase setup, database schema, and authentication UI"

trigger:
  manual: true
  on_approve: "quizhack_plan.md"

global:
  project_root: "./QuizHack"
  supabase_project_id: "${SUPABASE_PROJECT_ID}"
  knowledge_graph: "../knowledge_graph.json"
  
agents:
  - id: frontend_specialist
    config: "../.agents/ui_specialist.agent"
    context: "../context_packages/frontend_specialist_20260124_110022.md"
    state: "../agent_states/frontend_specialist_20260124_110022.yml"
    
  - id: backend_specialist
    config: "../.agents/backend_specialist.agent"
    context: "../context_packages/backend_specialist_20260124_110022.md"
    state: "../agent_states/backend_specialist_20260124_110022.yml"
    
  - id: db_architect
    config: "../.agents/db_builder.agent"
    context: "../context_packages/db_architect_20260124_110022.md"
    state: "../agent_states/db_architect_20260124_110022.yml"

pipeline:
  # Task 1: Supabase Project Setup
  - task: supabase_setup
    name: "Create Supabase Project"
    assigned_to: backend_specialist
    actions:
      - create_supabase_project:
          name: "QuizHack"
          region: "eu-central-1"
      - enable_oauth_provider:
          provider: "google"
          redirect_urls:
            - "quizhack://auth/callback"
            - "http://localhost:19006/auth/callback"
      - store_credentials:
          env_file: "../QuizHack/.env"
          variables:
            - SUPABASE_URL
            - SUPABASE_ANON_KEY
    verification:
      - supabase_project_exists: true
      - oauth_enabled: true
      - env_file_created: true
    outputs:
      - supabase_url
      - supabase_anon_key

  # Task 2: Database Schema Creation
  - task: database_schema
    name: "Create Database Tables"
    assigned_to: db_architect
    depends_on: [supabase_setup]
    actions:
      - execute_sql:
          file: "../QuizHack/supabase/migrations/001_initial_schema.sql"
          content: |
            -- Create profiles table (extends auth.users)
            CREATE TABLE IF NOT EXISTS public.profiles (
              id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
              email TEXT,
              avatar_type TEXT CHECK (avatar_type IN ('male', 'female', 'neutral')),
              pin_hash TEXT,
              created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
              updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
            );
            
            -- Create capture_sessions table
            CREATE TABLE IF NOT EXISTS public.capture_sessions (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
              started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
              ended_at TIMESTAMP WITH TIME ZONE,
              questions_detected INT DEFAULT 0,
              status TEXT DEFAULT 'active' CHECK (status IN ('active', 'completed', 'failed'))
            );
            
            -- Create questions table
            CREATE TABLE IF NOT EXISTS public.questions (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              session_id UUID REFERENCES public.capture_sessions(id) ON DELETE CASCADE,
              question_text TEXT NOT NULL,
              answer TEXT,
              confidence_score FLOAT CHECK (confidence_score >= 0 AND confidence_score <= 1),
              detected_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
              source TEXT DEFAULT 'screen' CHECK (source IN ('screen', 'audio'))
            );
            
            -- Enable Row Level Security
            ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
            ALTER TABLE public.capture_sessions ENABLE ROW LEVEL SECURITY;
            ALTER TABLE public.questions ENABLE ROW LEVEL SECURITY;
            
            -- RLS Policies for profiles
            CREATE POLICY "Users can view own profile"
              ON public.profiles FOR SELECT
              USING (auth.uid() = id);
            
            CREATE POLICY "Users can update own profile"
              ON public.profiles FOR UPDATE
              USING (auth.uid() = id);
            
            CREATE POLICY "Users can insert own profile"
              ON public.profiles FOR INSERT
              WITH CHECK (auth.uid() = id);
            
            -- RLS Policies for sessions
            CREATE POLICY "Users can view own sessions"
              ON public.capture_sessions FOR SELECT
              USING (auth.uid() = user_id);
            
            CREATE POLICY "Users can create own sessions"
              ON public.capture_sessions FOR INSERT
              WITH CHECK (auth.uid() = user_id);
            
            CREATE POLICY "Users can update own sessions"
              ON public.capture_sessions FOR UPDATE
              USING (auth.uid() = user_id);
            
            -- RLS Policies for questions
            CREATE POLICY "Users can view questions from own sessions"
              ON public.questions FOR SELECT
              USING (
                EXISTS (
                  SELECT 1 FROM public.capture_sessions
                  WHERE capture_sessions.id = questions.session_id
                  AND capture_sessions.user_id = auth.uid()
                )
              );
            
            CREATE POLICY "Users can insert questions to own sessions"
              ON public.questions FOR INSERT
              WITH CHECK (
                EXISTS (
                  SELECT 1 FROM public.capture_sessions
                  WHERE capture_sessions.id = questions.session_id
                  AND capture_sessions.user_id = auth.uid()
                )
              );
            
            -- Create indexes for performance
            CREATE INDEX idx_profiles_email ON public.profiles(email);
            CREATE INDEX idx_sessions_user_id ON public.capture_sessions(user_id);
            CREATE INDEX idx_sessions_status ON public.capture_sessions(status);
            CREATE INDEX idx_questions_session_id ON public.questions(session_id);
            CREATE INDEX idx_questions_detected_at ON public.questions(detected_at DESC);
    verification:
      - tables_created: ["profiles", "capture_sessions", "questions"]
      - rls_enabled: true
      - policies_created: true
    outputs:
      - migration_file_path

  # Task 3: Authentication Service
  - task: auth_service
    name: "Build Authentication Service"
    assigned_to: backend_specialist
    depends_on: [database_schema]
    actions:
      - create_file:
          path: "../QuizHack/src/services/auth.service.ts"
          template: "typescript_service"
      - create_file:
          path: "../QuizHack/src/config/supabase.ts"
          template: "supabase_config"
    verification:
      - service_file_exists: true
      - config_file_exists: true
    outputs:
      - auth_service_path

  # Task 4: UI Components
  - task: ui_components
    name: "Build Auth UI Components"
    assigned_to: frontend_specialist
    depends_on: [auth_service]
    actions:
      - create_screen:
          name: "LoginScreen"
          path: "../QuizHack/src/screens/LoginScreen.tsx"
          features:
            - google_oauth_button
            - email_password_form
            - error_handling
      - create_screen:
          name: "ProfileScreen"
          path: "../QuizHack/src/screens/ProfileScreen.tsx"
          features:
            - avatar_selector
            - masked_email_display
            - capture_control_buttons
      - create_component:
          name: "PINModal"
          path: "../QuizHack/src/components/PINModal.tsx"
          features:
            - six_digit_input
            - numeric_keypad
            - biometric_fallback
    verification:
      - all_screens_created: true
      - navigation_configured: true
      - components_tested: true
    outputs:
      - screens_paths
      - components_paths

  # Task 5: Avatar Assets
  - task: avatar_assets
    name: "Create Avatar SVG Assets"
    assigned_to: frontend_specialist
    depends_on: []
    actions:
      - create_svg:
          name: "male_avatar.svg"
          path: "../QuizHack/src/assets/avatars/male_avatar.svg"
      - create_svg:
          name: "female_avatar.svg"
          path: "../QuizHack/src/assets/avatars/female_avatar.svg"
      - create_svg:
          name: "neutral_robot.svg"
          path: "../QuizHack/src/assets/avatars/neutral_robot.svg"
    verification:
      - all_svgs_created: true
      - svgs_valid: true

  # Task 6: PIN Security Service
  - task: pin_service
    name: "Build PIN Security Service"
    assigned_to: backend_specialist
    depends_on: [auth_service]
    actions:
      - create_file:
          path: "../QuizHack/src/services/pin.service.ts"
          features:
            - hash_pin_with_bcrypt
            - verify_pin
            - store_in_keychain
            - validate_pin_format
    verification:
      - pin_hashing_works: true
      - keychain_storage_works: true

verification_gates:
  - name: "Phase 1 Complete"
    checks:
      - supabase_project_live: true
      - database_schema_deployed: true
      - rls_policies_active: true
      - auth_flow_functional: true
      - ui_components_render: true
      - pin_security_tested: true
    on_pass: "proceed_to_phase_2"
    on_fail: "escalate_to_meta_architect"

escalation_rules:
  - condition: "task duration > 30 minutes"
    action: "notify_meta_architect"
  - condition: "agent status == BLOCKED"
    action: "pause_workflow_and_escalate"
  - condition: "verification_gate fails"
    action: "rollback_and_request_approval"

logging:
  level: "INFO"
  output: "../logs/quizhack_phase1.log"
  include_agent_actions: true
  include_verifications: true
