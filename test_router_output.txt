
> @brainbox/extension@3.0.1 test:router /home/stefanov/Projects/Chat Organizer Cursor/apps/extension
> vitest --run src/background/modules/__tests__/messageRouter.test.ts


 RUN  v3.2.4 /home/stefanov/Projects/Chat Organizer Cursor/apps/extension

stdout | src/background/modules/__tests__/messageRouter.test.ts
[DEBUG] platformAdapters mock state: function

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > listen() > should register message listener
[MessageRouter] ğŸ“¡ Listening for messages... 

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > setAuthToken > should store tokens and trigger prompt sync
[MessageRouter] ğŸ“¨ Action: setAuthToken { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > setAuthToken > should handle auth errors
[MessageRouter] ğŸ“¨ Action: setAuthToken { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > checkDashboardSession > should return session validity
[MessageRouter] ğŸ“¨ Action: checkDashboardSession { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > syncAll > should sync auth and prompts
[MessageRouter] ğŸ“¨ Action: syncAll { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > fetchPrompts > should return all prompts
[MessageRouter] ğŸ“¨ Action: fetchPrompts { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > syncPrompts > should trigger prompt sync
[MessageRouter] ğŸ“¨ Action: syncPrompts { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > injectGeminiMainScript > should inject script into active tab
[MessageRouter] ğŸ“¨ Action: injectGeminiMainScript { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > injectGeminiMainScript > should handle missing tab gracefully
[MessageRouter] ğŸ“¨ Action: injectGeminiMainScript { senderId: [32m'internal'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > storeGeminiToken > should store token in storage
[MessageRouter] ğŸ“¨ Action: storeGeminiToken { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > storeGeminiToken > should store token in storage
[MessageRouter] âœ… Gemini AT token stored 

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > storeGeminiToken > should handle missing token
[MessageRouter] ğŸ“¨ Action: storeGeminiToken { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > getConversation > should fetch conversation from platform
[MessageRouter] ğŸ“¨ Action: getConversation { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should save conversation to dashboard
[MessageRouter] ğŸ“¨ Action: saveToDashboard { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should save conversation to dashboard
[MessageRouter] ğŸ”‘ saveToDashboard requested. Session active: true 

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should handle token expiry and trigger re-auth flow
[MessageRouter] ğŸ“¨ Action: saveToDashboard { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should handle token expiry and trigger re-auth flow
[MessageRouter] ğŸ”‘ saveToDashboard requested. Session active: true 

stderr | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should handle token expiry and trigger re-auth flow
[MessageRouter] ğŸš¨ âŒ saveToDashboard failed Error: Unauthorized
    at [90m/home/stefanov/Projects/Chat Organizer Cursor/apps/extension/[39msrc/background/modules/__tests__/messageRouter.test.ts:349:69
    at file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:155:11
    at file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:26
    at file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1863:10)
    at runTest (file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1574:12)
    at runSuite (file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1729:8)
    at runSuite (file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1729:8)
    at runSuite (file:///home/stefanov/Projects/Chat%20Organizer%20Cursor/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1729:8)

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > getUserFolders > should fetch user folders
[MessageRouter] ğŸ“¨ Action: getUserFolders { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > openLoginPage > should open login page in new tab
[MessageRouter] ğŸ“¨ Action: openLoginPage { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > Unknown action > should return false for unknown actions
[MessageRouter] ğŸ“¨ Action: unknownAction { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

 â¯ src/background/modules/__tests__/messageRouter.test.ts (17 tests | 1 failed) 1528ms
   âœ“ MessageRouter > listen() > should register message listener 2ms
   âœ“ MessageRouter > setAuthToken > should store tokens and trigger prompt sync 53ms
   âœ“ MessageRouter > setAuthToken > should handle auth errors 51ms
   Ã— MessageRouter > checkDashboardSession > should return session validity 1004ms
     â†’ expected "spy" to be called at least once
   âœ“ MessageRouter > syncAll > should sync auth and prompts 51ms
   âœ“ MessageRouter > fetchPrompts > should return all prompts 52ms
   âœ“ MessageRouter > syncPrompts > should trigger prompt sync 51ms
   âœ“ MessageRouter > injectGeminiMainScript > should inject script into active tab 1ms
   âœ“ MessageRouter > injectGeminiMainScript > should handle missing tab gracefully 1ms
   âœ“ MessageRouter > storeGeminiToken > should store token in storage 51ms
   âœ“ MessageRouter > storeGeminiToken > should handle missing token 1ms
   âœ“ MessageRouter > getConversation > should fetch conversation from platform 51ms
   âœ“ MessageRouter > saveToDashboard > should save conversation to dashboard 51ms
   âœ“ MessageRouter > saveToDashboard > should handle token expiry and trigger re-auth flow 51ms
   âœ“ MessageRouter > getUserFolders > should fetch user folders 51ms
   âœ“ MessageRouter > openLoginPage > should open login page in new tab 1ms
   âœ“ MessageRouter > Unknown action > should return false for unknown actions 1ms

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 1 â¯â¯â¯â¯â¯â¯â¯

 FAIL  src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > checkDashboardSession > should return session validity
AssertionError: expected "spy" to be called at least once
 â¯ src/background/modules/__tests__/messageRouter.test.ts:161:48
    159| 
    160|       await vi.waitFor(() => {
    161|         expect(mockAuthManager.isSessionValid).toHaveBeenCalled();
       |                                                ^
    162|         expect(sendResponse).toHaveBeenCalledWith({
    163|           success: true,

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯


 Test Files  1 failed (1)
      Tests  1 failed | 16 passed (17)
   Start at  01:19:08
   Duration  2.40s (transform 75ms, setup 37ms, collect 47ms, tests 1.53s, environment 362ms, prepare 145ms)

/home/stefanov/Projects/Chat Organizer Cursor/apps/extension:
â€‰ERR_PNPM_RECURSIVE_RUN_FIRST_FAILâ€‰ @brainbox/extension@3.0.1 test:router: `vitest --run src/background/modules/__tests__/messageRouter.test.ts`
Exit status 1
