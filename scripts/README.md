# BrainBox Scripts

–ü–æ–º–æ—â–Ω–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤–µ –∑–∞ —Ç–µ—Å—Ç–≤–∞–Ω–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ BrainBox API –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è—Ç–∞ –Ω–∞ —Ä–∞–∑—à–∏—Ä–µ–Ω–∏–µ—Ç–æ.

## üöÄ –ù–∞–ª–∏—á–Ω–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤–µ

### 1. API Test Suite (`test-api.js`)
–ò–∑—á–µ—Ä–ø–∞—Ç–µ–ª–µ–Ω —Ç–µ—Å—Ç –Ω–∞ –≤—Å–∏—á–∫–∏ API –µ–Ω–¥–ø–æ–π–Ω—Ç–æ–≤–µ –Ω–∞ Dashboard-–∞. –ü—Ä–æ–≤–µ—Ä—è–≤–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç, –∞—É—Ç–µ–Ω—Ç–∏–∫–∞—Ü–∏—è –∏ CORS.

**–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ:**
```bash
npm run test:api
```

### 2. Extension Sync Validation (`validate_extension_sync.js`)
–°–ø–µ—Ü–∏—Ñ–∏—á–µ–Ω —Ç–µ—Å—Ç –∑–∞ –ª–æ–≥–∏–∫–∞—Ç–∞ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–Ω–æ—Ç–æ —Ä–∞–∑—à–∏—Ä–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—è–≤–∞:
- Supabase Authentication –ø–æ—Ç–æ–∫.
- **Upsert –ª–æ–≥–∏–∫–∞**: –£–≤–µ—Ä—è–≤–∞ —Å–µ, —á–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω –∑–∞–ø–∏—Å –Ω–∞ —Å—ä—â–∏—è —á–∞—Ç (—Å—ä—â–æ—Ç–æ URL/ID), —Ç–æ–π —Å–µ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞, –≤–º–µ—Å—Ç–æ –¥–∞ —Å–µ —Å—ä–∑–¥–∞–≤–∞ –¥—É–±–ª–∏–∫–∞—Ç.
- –ò–Ω—Ç–µ–≥—Ä–∏—Ç–µ—Ç –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ (—Å—ä–æ–±—â–µ–Ω–∏—è, –º–µ—Ç–∞–¥–∞–Ω–Ω–∏).

**–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ:**
```bash
node scripts/validate_extension_sync.js
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–∫—Ä–∏–ø—Ç–æ–≤–µ—Ç–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ç environment –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏ –∑–∞ –≥—ä–≤–∫–∞–≤–æ—Å—Ç. –ú–æ–∂–µ—Ç–µ –¥–∞ –≥–∏ –ø–æ–¥–∞–¥–µ—Ç–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:

| –ü—Ä–æ–º–µ–Ω–ª–∏–≤–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|------------|----------|---------|
| `API_BASE_URL` | –ë–∞–∑–æ–≤ URL –Ω–∞ Dashboard-–∞ | `http://localhost:3000` |
| `TEST_EMAIL` | Email –∑–∞ —Ç–µ—Å—Ç–æ–≤–∏—è –∞–∫–∞—É–Ω—Ç | `test@example.com` |
| `TEST_PASSWORD` | –ü–∞—Ä–æ–ª–∞ –∑–∞ —Ç–µ—Å—Ç–æ–≤–∏—è –∞–∫–∞—É–Ω—Ç | `testpassword123` |

### –ü—Ä–∏–º–µ—Ä–∏:

```bash
# –¢–µ—Å—Ç–≤–∞–Ω–µ –Ω–∞ –ª–æ–∫–∞–ª–µ–Ω —Å—ä—Ä–≤—ä—Ä —Å custom –∞–∫–∞—É–Ω—Ç
TEST_EMAIL=user@test.bg TEST_PASSWORD=my_secret npm run test:api

# –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è—Ç–∞ –∫—ä–º Production (Vercel)
API_BASE_URL=https://brainbox-alpha.vercel.app TEST_EMAIL=demo@brainbox.site node scripts/validate_extension_sync.js
```

# BrainBox Scripts

Utility scripts for BrainBox AI Chat Organizer development and maintenance.

---

## Table of Contents

1. [verification.py](#verificationpy) - Schema & UI compliance checks
2. [setup-verification-hook.sh](#setup-verification-hooksh) - Git pre-commit hook installer

---

## verification.py

**Purpose**: Automated pre-commit checks for Identity-Locked schema and UI standard violations.

**Version**: 2.0.6  
**Python**: 3.8+  
**Dependencies**: None (stdlib only)

### Usage

```bash
# Run all checks
python3 scripts/verification.py

# Individual checks (future)
python3 scripts/verification.py --check-schema
python3 scripts/verification.py --check-ui
python3 scripts/verification.py --check-csp
```

### Checks Performed

#### 1. Identity-Locked Fields Protection
**Gate**: `database_types_protection`  
**Severity**: Critical

Verifies `src/types/database.types.ts` hasn't been manually edited.

**Why**: File is auto-generated by `supabase db pull`. Manual edits are overwritten.

**Violation example**:
```
‚ö†Ô∏è  database.types.ts may have been manually edited!
   Solution: Revert changes and create a Supabase migration instead.
```

**Correct workflow**:
```sql
-- supabase/migrations/20260131_add_field.sql
ALTER TABLE chats ADD COLUMN ai_model text;
```
```bash
supabase db pull  # Regenerates database.types.ts
```

#### 2. CSS Variable Protection
**Gate**: `css_variable_protection`  
**Severity**: Critical

Blocks changes to brand color HSL values in `src/app/globals.css`.

**Protected variables**:
- `--primary` (221.2 83.2% 53.3% ‚Üí #3B82F6)
- `--destructive`
- `--background`
- `--foreground`

**Violation example**:
```
üö® IDENTITY-LOCKED VIOLATION: --primary color changed!
   Expected: 221.2 83.2% 53.3% (#3B82F6)
   Current:  240 50% 60%
   Reason: Brand colors are Identity-Locked per UI_STANDARDS.md:1
```

**Rationale**: Maintains visual identity consistency across PWA and extension.

#### 3. Manifest V3 CSP Compliance
**Gate**: `manifest_v3_csp_compliance`  
**Severity**: Critical

Detects Content Security Policy violations in extension files.

**Blocked patterns**:
- `eval()` or `Function()` constructor in service worker
- External CDN links in HTML files (`https://cdn.*`, `https://unpkg.*`)

**Exception**: Google Fonts allowed (`https://fonts.googleapis.com`)

**Violation example**:
```
‚ö†Ô∏è  CSP Violation in popup.html: External CDN detected
   Pattern: src="https://cdn\.
   Solution: Bundle assets locally in extension/ directory
```

### Exit Codes

- `0`: All checks passed
- `1`: One or more checks failed (blocks commit if used as pre-commit hook)

### Integration with Git

**Install pre-commit hook**:
```bash
bash scripts/setup-verification-hook.sh
```

**Test**:
```bash
# Make a change
echo "// test" >> src/app/globals.css

# Try to commit
git add src/app/globals.css
git commit -m "test"
# ‚Üí Verification runs automatically
```

**Bypass** (not recommended):
```bash
git commit --no-verify
```

---

## setup-verification-hook.sh

**Purpose**: Install verification.py as Git pre-commit hook.

**Usage**:
```bash
bash scripts/setup-verification-hook.sh
```

**What it does**:
1. Creates `.git/hooks/pre-commit`
2. Makes it executable
3. Configures to run `python3 scripts/verification.py` before each commit

**Output**:
```
üîß Installing BrainBox verification pre-commit hook...
‚úÖ Pre-commit hook installed at .git/hooks/pre-commit

To test: make a change and run 'git commit'
To bypass: use 'git commit --no-verify' (not recommended)
```

---

## Development

### Adding New Verification Checks

1. **Add function** to `verification.py`:
```python
def check_new_rule() -> Tuple[bool, str]:
    """Description of check"""
    # ... validation logic ...
    if violation_detected:
        return False, "Error message"
    return True, ""
```

2. **Register in main()**:
```python
checks = [
    # ... existing checks ...
    ("New Rule Name", check_new_rule),
]
```

3. **Add quality gate** to `.workflows/verification_gate.yml`:
```yaml
quality_gates:
  - name: new_rule
    description: "Description"
    severity: critical|high|medium
    check: new_rule_function
```

### Testing Verification Logic

**Simulate CSS violation**:
```bash
# Backup
cp src/app/globals.css src/app/globals.css.backup

# Modify --primary
sed -i 's/221.2 83.2% 53.3%/240 50% 60%/g' src/app/globals.css

# Run verification (should fail)
python3 scripts/verification.py

# Restore
mv src/app/globals.css.backup src/app/globals.css
```

---

## References

**Technical Documentation**:
- [DATA_SCHEMA.md](../docs/technical/DATA_SCHEMA.md) - Canonical models
- [UI_STANDARDS.md](../docs/technical/UI_STANDARDS.md) - Visual identity
- [CONTEXT_MAP.md](../docs/technical/CONTEXT_MAP.md) - Boundary definitions

**Implementation Files**:
- [verification.py](./verification.py) - Main script (225 lines)
- [knowledge_graph.json](../AI%20Knowlage/knowledge_graph.json) - Architectural nodes

---

## ‚ö†Ô∏è –ò–∑–∏—Å–∫–≤–∞–Ω–∏—è
- Node.js 18+ (–∑–∞—Ä–∞–¥–∏ –≤–≥—Ä–∞–¥–µ–Ω–∏—è `fetch`).
- –í–∞–ª–∏–¥–µ–Ω `.env.local` —Ñ–∞–π–ª —Å `NEXT_PUBLIC_SUPABASE_URL` –∏ `NEXT_PUBLIC_SUPABASE_ANON_KEY` –∑–∞ `validate_extension_sync.js`.
