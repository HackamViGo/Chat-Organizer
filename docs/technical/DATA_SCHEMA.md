# Data Schema Documentation

**Project**: BrainBox AI Chat Organizer  
**Version**: 2.0.6  
**Type System**: TypeScript + Zod + Supabase PostgreSQL  
**Generated**: 2026-01-31  
**Authority**: Meta-Architect (Priority 1 - Identity-Locked)

---

## ‚ö†Ô∏è CRITICAL NOTICE FOR FUTURE AGENTS

**IDENTITY-LOCKED SCHEMA**: This document defines canonical data models that MUST NOT be modified without:
1. Updating this document first
2. Running database migrations (Supabase)
3. Updating TypeScript types (`packages/shared/src/types/database.ts`)
4. Updating API validation schemas (Zod in `packages/validation/src/`)
5. Updating extension normalizers (`apps/extension/src/lib/normalizers.js`)

**VIOLATION OF THIS RULE = SYSTEM FAILURE**

---

## 1. Entity-Relationship Diagram

```mermaid
erD diagram
    USERS ||--o{ CHATS : owns
    USERS ||--o{ PROMPTS : creates
    USERS ||--o{ FOLDERS : organizes
    USERS ||--o{ IMAGES : uploads
    USERS ||--o{ LISTS : manages
    
    FOLDERS ||--o{ CHATS : contains
    FOLDERS ||--o{ PROMPTS : contains
    FOLDERS ||--o{ IMAGES : contains
    FOLDERS ||--o{ LISTS : contains
    FOLDERS ||--o{ FOLDERS : nests
    
    LISTS ||--o{ LIST_ITEMS : contains
    
    USERS {
        uuid id PK "Identity-Locked"
        string email UK "Identity-Locked"
        string full_name
        string avatar_url
        jsonb settings "User preferences (Quick Access, etc.)"
        timestamp created_at
        timestamp updated_at
    }
    
    CHATS {
        uuid id PK "Identity-Locked"
        uuid user_id FK "Identity-Locked"
        uuid folder_id FK
        string source_id UK "Platform conversation ID"
        string title
        text content "Formatted markdown"
        jsonb messages "Array of Message objects"
        string platform "chatgpt|claude|gemini"
        string url "Deep link to conversation"
        text summary "Brief AI summary"
        text detailed_summary "Comprehensive AI summary"
        jsonb tags "AI-generated tags"
        jsonb tasks "Extracted tasks"
        vector embedding "Semantic search embedding"
        boolean is_archived
        timestamp created_at
        timestamp updated_at
    }
    
    PROMPTS {
        uuid id PK "Identity-Locked"
        uuid user_id FK "Identity-Locked"
        uuid folder_id FK
        string title
        text content
        string color "Hex color code"
        boolean use_in_context_menu
        timestamp created_at
        timestamp updated_at
    }
    
    FOLDERS {
        uuid id PK "Identity-Locked"
        uuid user_id FK "Identity-Locked"
        uuid parent_id FK "Self-reference (max 4 levels)"
        string name
        string icon "Emoji or icon name"
        string color "Hex color code"
        enum type "chat|prompt|image|list"
        timestamp created_at
        timestamp updated_at
    }
    
    IMAGES {
        uuid id PK "Identity-Locked"
        uuid user_id FK "Identity-Locked"
        uuid folder_id FK
        string url "Supabase Storage URL"
        string path "Storage bucket path"
        string name "Original filename"
        string source_url "Original platform URL"
        string mime_type
        integer size "Bytes"
        timestamp created_at
    }
    
    LISTS {
        uuid id PK "Identity-Locked"
        uuid user_id FK "Identity-Locked"
        uuid folder_id FK
        string title
        string color "emerald|blue|purple|amber|rose|cyan"
        timestamp created_at
        timestamp updated_at
    }
    
    LIST_ITEMS {
        uuid id PK "Identity-Locked"
        uuid list_id FK "Identity-Locked"
        string text
        boolean completed
        integer position "Ordering"
        timestamp created_at
    }
```

---

## 2. Canonical Models

### 2.1 The Chat Object

**Purpose**: Stores synchronized AI conversations from ChatGPT, Claude, Gemini

#### TypeScript Definition

**File**: `packages/shared/src/types/index.ts`, `packages/shared/src/types/database.ts`

```typescript
export type Chat = {
  // Identity-Locked Fields (Priority 1)
  id: string;                                // UUID (generated by Supabase)
  user_id: string;                           // UUID (from Supabase Auth)
  
  // Core Fields
  title: string;                             // Required, min 1 char
  content: string | null;                    // Formatted markdown (full conversation)
  messages: Json | null;                     // Array<Message> (see section 2.1.2)
  platform: string | null;                   // 'chatgpt' | 'claude' | 'gemini'
  url: string | null;                        // Deep link (e.g. https://chatgpt.com/c/abc123)
  source_id: string | null;                  // Unique constraint with user_id
  
  // Organization
  folder_id: string | null;                  // FK to folders table
  is_archived: boolean | null;               // Default: false
  
  // AI-Enhanced Fields
  summary: string | null;                    // Brief AI summary (markdown)
  detailed_summary: string | null;           // Comprehensive AI summary (markdown)
  tags: string[] | null;                     // AI-generated tags (stored as jsonb)
  tasks: string[] | null;                    // Actionable items (stored as jsonb)
  embedding: number[] | null;                // Vector embedding for semantic search (1536d or 768d)
  
  // Timestamps
  created_at: string | null;                 // ISO 8601
  updated_at: string | null;                 // ISO 8601
};
```

#### Message Structure (Nested JSON)

**File**: `packages/shared/src/types/index.ts`

```typescript
interface Message {
  id: string;                    // UUID or platform-specific ID
  role: 'user' | 'assistant' | 'system';
  content: string;               // Plain text or markdown
  timestamp: number;             // Unix milliseconds
  metadata?: {
    images?: string[];           // Image URLs
    attachments?: any[];         // File attachments
    model?: string;              // e.g. 'gpt-4', 'claude-3-opus'
    [key: string]: any;
  };
}
```

#### Example JSON (messages field)

```json
[
  {
    "id": "user_msg_1",
    "role": "user",
    "content": "Explain quantum computing",
    "timestamp": 1738294800000,
    "metadata": {}
  },
  {
    "id": "asst_msg_1",
    "role": "assistant",
    "content": "Quantum computing uses qubits...",
    "timestamp": 1738294805000,
    "metadata": {
      "model": "gpt-4-turbo"
    }
  }
]
```

#### Validation Rules

**Zod Schema**: `packages/validation/src/chat.ts`

```typescript
const createChatSchema = z.object({
  title: z.string().min(1),
  content: z.string(),
  platform: z.string().optional(),
  url: z.string().url().optional().or(z.literal('')),
  folder_id: z.string().uuid().nullable().optional(),
  source_id: z.string().optional(),
  messages: z.array(z.any()).optional(),
});
```

#### Database Constraints

- **Primary Key**: `id` (uuid, auto-generated)
- **Unique Constraint**: `(user_id, source_id)` (prevents duplicate syncs)
- **Foreign Keys**:
  - `user_id` ‚Üí `users.id` (ON DELETE CASCADE)
  - `folder_id` ‚Üí `folders.id` (ON DELETE SET NULL)

---

### 2.2 The Prompt Object

**Purpose**: User-created text templates for AI interactions

#### TypeScript Definition

**File**: `packages/shared/src/types/index.ts`, `packages/shared/src/types/database.ts`

```typescript
export type Prompt = {
  // Identity-Locked Fields (Priority 1)
  id: string;                                // UUID
  user_id: string;                           // UUID
  
  // Core Fields
  title: string;                             // Required
  content: string;                           // Required (prompt text)
  
  // Organization
  folder_id: string | null;                  // FK to folders
  color: string | null;                      // Hex code (default: '#6366f1')
  
  // Functionality
  use_in_context_menu: boolean | null;      // Show in browser context menu
  
  // Timestamps
  created_at: string | null;
  updated_at: string | null;
};
```

#### Validation Rules

**Zod Schema**: `packages/validation/src/prompt.ts`

```typescript
const createPromptSchema = z.object({
  title: z.string().min(1),
  content: z.string(),
  color: z.string().regex(/^#[0-9A-Fa-f]{6}$/).optional(),
  folder_id: z.string().uuid().nullable().optional(),
  use_in_context_menu: z.boolean().optional(),
});
```

#### Database Constraints

- **Primary Key**: `id` (uuid)
- **Foreign Keys**:
  - `user_id` ‚Üí `users.id` (ON DELETE CASCADE)
  - `folder_id` ‚Üí `folders.id` (ON DELETE SET NULL)

---

### 2.3 The Folder Object

**Purpose**: Hierarchical organization (up to 4 levels of nesting)

#### TypeScript Definition

**File**: `packages/shared/src/types/index.ts`, `packages/shared/src/types/database.ts`

```typescript
export type Folder = {
  // Identity-Locked Fields (Priority 1)
  id: string;                                // UUID
  user_id: string;                           // UUID
  
  // Core Fields
  name: string;                              // Required
  parent_id: string | null;                  // FK to folders (self-reference)
  type: 'chat' | 'list' | 'image' | 'prompt' | null;
  
  // UI Customization
  icon: string | null;                       // Emoji or icon name
  color: string | null;                      // Hex code
  
  // Timestamps
  created_at: string | null;
  updated_at: string | null;
};
```

#### Folder Hierarchy Rules

```
Root Folders (parent_id = null)
  ‚îÇ
  ‚îú‚îÄ Level 1 Folder (parent_id = root.id)
  ‚îÇ    ‚îÇ
  ‚îÇ    ‚îú‚îÄ Level 2 Folder (parent_id = level1.id)
  ‚îÇ    ‚îÇ    ‚îÇ
  ‚îÇ    ‚îÇ    ‚îî‚îÄ Level 3 Folder (parent_id = level2.id)
  ‚îÇ    ‚îÇ
  ‚îÇ    ‚îî‚îÄ Level 2 Folder
  ‚îÇ
  ‚îî‚îÄ Level 1 Folder
```

**CONSTRAINT**: Maximum nesting depth = 4 levels (enforced in UI, not database)

#### Database Constraints

- **Primary Key**: `id` (uuid)
- **Foreign Keys**:
  - `user_id` ‚Üí `users.id` (ON DELETE CASCADE)
  - `parent_id` ‚Üí `folders.id` (ON DELETE CASCADE - deletes all children)
- **Enum**: `type` ‚àà `['chat', 'list', 'image', 'prompt']`

---

### 2.4 The User Object

**Purpose**: User profile (managed by Supabase Auth)

#### TypeScript Definition

**File**: `packages/shared/src/types/index.ts`, `packages/shared/src/types/database.ts`

```typescript
export type User = {
  // Identity-Locked Fields (Priority 1)
  id: string;                                // UUID (from auth.users)
  email: string;                             // Unique, required
  
  // Profile
  full_name: string | null;
  avatar_url: string | null;                 // Supabase Storage URL
  settings: {
    quickAccessFolders?: string[];           // Max 3 folder IDs
    [key: string]: any;
  } | null;
  
  // Timestamps
  created_at: string | null;
  updated_at: string | null;
};
```

#### Database Constraints

- **Primary Key**: `id` (uuid, synced with `auth.users`)
- **Unique**: `email`

---

### 2.5 The Image Object

**Purpose**: User-uploaded images (screenshots, AI-generated, etc.)

#### TypeScript Definition

**File**: `packages/shared/src/types/index.ts`, `packages/shared/src/types/database.ts`

```typescript
export type Image = {
  // Identity-Locked Fields (Priority 1)
  id: string;                                // UUID
  user_id: string;                           // UUID
  
  // Storage
  url: string;                               // Required (Supabase Storage public URL)
  path: string | null;                       // Bucket path (e.g. 'user_id/filename.png')
  name: string | null;                       // Original filename
  
  // Metadata
  source_url: string | null;                 // Original URL (if synced from chat)
  mime_type: string | null;                  // e.g. 'image/png'
  size: number | null;                       // Bytes
  
  // Organization
  folder_id: string | null;                  // FK to folders
  
  // Timestamps
  created_at: string | null;
};
```

#### Database Constraints

- **Primary Key**: `id` (uuid)
- **Foreign Keys**:
  - `user_id` ‚Üí `users.id` (ON DELETE CASCADE)
  - `folder_id` ‚Üí `folders.id` (ON DELETE SET NULL)

---

### 2.6 The List Object (with List Items)

**Purpose**: To-do lists and task management

#### TypeScript Definition

**File**: `packages/shared/src/types/index.ts`, `packages/shared/src/types/database.ts`

```typescript
export type List = {
  // Identity-Locked Fields (Priority 1)
  id: string;                                // UUID
  user_id: string;                           // UUID
  
  // Core Fields
  title: string;                             // Required
  
  // Organization
  folder_id: string | null;                  // FK to folders
  color: string | null;                      // 'emerald' | 'blue' | 'purple' | etc.
  
  // Timestamps
  created_at: string | null;
  updated_at: string | null;
};

export type ListItem = {
  // Identity-Locked Fields (Priority 1)
  id: string;                                // UUID
  list_id: string;                           // UUID (FK to lists)
  
  // Core Fields
  text: string;                              // Required (task description)
  completed: boolean | null;                 // Default: false
  position: number | null;                   // Ordering (0, 1, 2, ...)
  
  // Timestamps
  created_at: string | null;
};
```

#### Database Constraints

**Lists**:
- **Primary Key**: `id` (uuid)
- **Foreign Keys**:
  - `user_id` ‚Üí `users.id` (ON DELETE CASCADE)
  - `folder_id` ‚Üí `folders.id` (ON DELETE SET NULL)

**List Items**:
- **Primary Key**: `id` (uuid)
- **Foreign Keys**:
  - `list_id` ‚Üí `lists.id` (ON DELETE CASCADE)

---

## 3. TypeScript ‚Üî Zod ‚Üî Database Mapping

### 3.1 Mapping Table

| Entity | TypeScript Type | Zod Validation | Database Table | API Route |
|--------|----------------|----------------|----------------|-----------|
| **Chat** | `Chat` (@brainbox/shared) | `createChatSchema` (@brainbox/validation) | `chats` | POST /api/chats |
| **Prompt** | `Prompt` (@brainbox/shared) | `createPromptSchema` (@brainbox/validation) | `prompts` | POST /api/prompts |
| **Folder** | `Folder` (@brainbox/shared) | `createFolderSchema` (@brainbox/validation) | `folders` | POST /api/folders |
| **User** | `User` (@brainbox/shared) | N/A (managed by Supabase Auth) | `users` | GET /api/user |
| **Image** | `Image` (@brainbox/shared) | `uploadImageSchema` (@brainbox/validation) | `images` | POST /api/upload |
| **List** | `List` (@brainbox/shared) | `createListSchema` (@brainbox/validation) | `lists` | POST /api/lists |

### 3.2 Extension ‚Üî API Mapping

**Normalizers** (`apps/extension/src/lib/normalizers.js`) transform platform-specific API responses into canonical `Chat` objects:

```
ChatGPT API Response ‚Üí normalizeChatGPT() ‚Üí Canonical Chat Object ‚Üí POST /api/chats
Claude API Response  ‚Üí normalizeClaude()   ‚Üí Canonical Chat Object ‚Üí POST /api/chats
Gemini API Response  ‚Üí normalizeGemini()   ‚Üí Canonical Chat Object ‚Üí POST /api/chats
```

### 3.3 Schema Factories

**File**: `packages/shared/src/types/index.ts`

```javascript
// Factory: Creates compliant conversation object
createConversation({
  id: string,
  platform: 'chatgpt' | 'claude' | 'gemini',
  title: string,
  messages: Message[],
  created_at: number,
  updated_at: number,
  metadata: object
}) ‚Üí Conversation

// Factory: Creates compliant message object
createMessage({
  id?: string,               // Default: crypto.randomUUID()
  role: 'user' | 'assistant' | 'system',
  content: string,
  timestamp?: number,        // Default: Date.now()
  metadata?: object
}) ‚Üí Message
```

---

## 4. Identity-Locked Fields (Priority 1)

**MODIFICATION PROHIBITED WITHOUT META-ARCHITECT APPROVAL**

### 4.1 Definition

Fields marked **Priority 1** are critical to system integrity and MUST NOT be:
- Renamed
- Changed type (e.g. `string` ‚Üí `number`)
- Removed
- Made nullable (if currently required)

### 4.2 Complete List

| Table | Field | Type | Reason |
|-------|-------|------|--------|
| **All tables** | `id` | `uuid` | Primary key (Supabase auto-generated) |
| **All tables** | `user_id` | `uuid` | Row-Level Security (RLS) enforcement |
| **chats** | `source_id` | `string` | Unique constraint with `user_id` (duplicate prevention) |
| **users** | `email` | `string` | Unique identifier (Supabase Auth relies on this) |
| **list_items** | `list_id` | `uuid` | Parent relationship (CASCADE delete) |

### 4.3 Enforcement Mechanism

**Database**: Supabase Row-Level Security (RLS) policies filter by `user_id`

Example policy (not in codebase, configured via dashboard):

```sql
CREATE POLICY "Users can only access their own chats"
ON chats FOR ALL
USING (auth.uid() = user_id);
```

**TypeScript**: `Insert` and `Update` types enforce required fields

**Zod**: API validation rejects missing or invalid values

---

## 5. Expected Database Schema (SQL)

**Note**: Generated from `src/types/database.types.ts` (Supabase CLI: `supabase db pull`)

### 5.1 Chats Table

```sql
CREATE TABLE public.chats (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    folder_id uuid REFERENCES public.folders(id) ON DELETE SET NULL,
    source_id text,
    title text NOT NULL,
    content text,
    messages jsonb,
    platform text,
    url text,
    summary text,
    tasks jsonb,
    is_archived boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    
    CONSTRAINT chats_user_source_unique UNIQUE (user_id, source_id)
);

CREATE INDEX idx_chats_user_id ON public.chats(user_id);
CREATE INDEX idx_chats_folder_id ON public.chats(folder_id);
CREATE INDEX idx_chats_platform ON public.chats(platform);
```

### 5.2 Prompts Table

```sql
CREATE TABLE public.prompts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    folder_id uuid REFERENCES public.folders(id) ON DELETE SET NULL,
    title text NOT NULL,
    content text NOT NULL,
    color text DEFAULT '#6366f1',
    use_in_context_menu boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

CREATE INDEX idx_prompts_user_id ON public.prompts(user_id);
CREATE INDEX idx_prompts_use_in_context_menu ON public.prompts(use_in_context_menu) WHERE use_in_context_menu = true;
```

### 5.3 Folders Table

```sql
CREATE TYPE folder_type_enum AS ENUM ('chat', 'list', 'image', 'prompt');

CREATE TABLE public.folders (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    parent_id uuid REFERENCES public.folders(id) ON DELETE CASCADE,
    name text NOT NULL,
    icon text,
    color text,
    type folder_type_enum,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

CREATE INDEX idx_folders_user_id ON public.folders(user_id);
CREATE INDEX idx_folders_parent_id ON public.folders(parent_id);
```

### 5.4 Users Table

```sql
CREATE TABLE public.users (
    id uuid PRIMARY KEY,  -- Synced from auth.users
    email text NOT NULL UNIQUE,
    full_name text,
    avatar_url text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

-- Trigger: Auto-create user profile when auth user registers
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
    INSERT INTO public.users (id, email, full_name, avatar_url)
    VALUES (new.id, new.email, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url');
    RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

### 5.5 Images Table

```sql
CREATE TABLE public.images (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    folder_id uuid REFERENCES public.folders(id) ON DELETE SET NULL,
    url text NOT NULL,
    path text,
    name text,
    source_url text,
    mime_type text,
    size integer,
    created_at timestamp with time zone DEFAULT now()
);

CREATE INDEX idx_images_user_id ON public.images(user_id);
CREATE INDEX idx_images_folder_id ON public.images(folder_id);
```

### 5.6 Lists & List Items Tables

```sql
CREATE TABLE public.lists (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    folder_id uuid REFERENCES public.folders(id) ON DELETE SET NULL,
    title text NOT NULL,
    color text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

CREATE TABLE public.list_items (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    list_id uuid NOT NULL REFERENCES public.lists(id) ON DELETE CASCADE,
    text text NOT NULL,
    completed boolean DEFAULT false,
    position integer,
    created_at timestamp with time zone DEFAULT now()
);

CREATE INDEX idx_lists_user_id ON public.lists(user_id);
CREATE INDEX idx_list_items_list_id ON public.list_items(list_id);
CREATE INDEX idx_list_items_position ON public.list_items(list_id, position);
```

---

## 6. Platform-Specific Extraction Logic

### 6.1 ChatGPT Message Extraction

**File**: `apps/extension/src/lib/normalizers.js`

**Strategy**: Linear reconstruction from tree structure

```javascript
// ChatGPT stores messages as a tree (mapping object)
// We traverse from current_node backwards to reconstruct linear history
let currentNodeId = rawData.current_node;
while (currentNodeId) {
    const node = rawData.mapping[currentNodeId];
    if (node.message) {
        processChatGPTMessage(node.message, messages);
    }
    currentNodeId = node.parent;
}
messages.reverse();  // Oldest first
```

### 6.2 Claude Message Extraction

**File**: `apps/extension/src/lib/normalizers.js`

**Strategy**: Direct array mapping

```javascript
// Claude API returns linear array of chat_messages
const messages = rawData.chat_messages.map(msg => createMessage({
    id: msg.uuid,
    role: msg.sender === 'human' ? 'user' : 'assistant',
    content: msg.text,
    timestamp: new Date(msg.created_at).getTime()
}));
```

### 6.3 Gemini Message Extraction

**File**: `apps/extension/src/lib/normalizers.js`

**Strategy**: Recursive nested array traversal with deduplication

```javascript
// Gemini returns deeply nested arrays: [[[[text, null, null, [images]]]]]
const extractedMessages = extractGeminiMessages(parsedData);

// Role determination heuristics:
// - User messages: short commands, questions, imperative verbs
// - Assistant messages: long detailed responses, structured formatting
// - Alternating pattern fallback
const role = determineGeminiRoleImproved(text, index, previousMessages);
```

**Challenge**: Gemini structure varies by conversation type (text-only vs. image generation)

**Solution**: Recursive extraction + content analysis (regex patterns for Bulgarian/English commands)

---

## 7. Modification Workflow

### 7.1 When Schema Changes Are Needed

**Example**: Adding new field `ai_model: string` to `chats` table

**Correct Workflow**:

1. **Update this document first** (add field to section 2.1)
2. **Create Supabase migration**:
   ```sql
   ALTER TABLE chats ADD COLUMN ai_model text;
   ```
3. **Update TypeScript types**:
   ```typescript
   // packages/shared/src/types/database.ts
   export type Chat = {
     ...
     ai_model: string | null;
   };
   ```
4. **Update Zod validation**:
   ```typescript
   // src/app/api/chats/route.ts
   const createChatSchema = z.object({
     ...
     ai_model: z.string().optional(),
   });
   ```
5. **Update extension normalizers**:
   ```javascript
   // extension/lib/normalizers.js
   metadata: {
     model: rawData.model_slug  // Extract from platform API
   }
   ```
6. **Test sync pipeline**: ChatGPT ‚Üí Extension ‚Üí API ‚Üí Database
7. **Update Memory MCP** with new schema entity

### 7.2 Prohibited Changes

‚ùå Renaming `user_id` to `owner_id` (breaks RLS policies)  
‚ùå Making `title` nullable (violates NOT NULL constraint)  
‚ùå Changing `id` from `uuid` to `integer` (breaks foreign keys)  
‚ùå Removing `source_id` (breaks duplicate prevention logic)

---

## 8. Validation Summary

### 8.1 Validation Layers

```
User Input ‚Üí Zod (API) ‚Üí TypeScript (type safety) ‚Üí Supabase (constraints) ‚Üí RLS (security)
```

**Layer 1: Zod (Runtime)**  
- Rejects invalid types, missing required fields, malformed UUIDs
- Location: `src/app/api/*/route.ts`

**Layer 2: TypeScript (Compile-time)**  
- Prevents type mismatches during development
- Location: `src/types/index.ts`, `src/types/database.types.ts`

**Layer 3: Supabase (Database)**  
- Enforces NOT NULL, UNIQUE, FOREIGN KEY, CHECK constraints
- Location: PostgreSQL (managed via Supabase dashboard)

**Layer 4: RLS (Authorization)**  
- Ensures users only access their own data
- Location: Supabase policies (SQL)

### 8.2 Extension Validation

**File**: `extension/lib/schemas.js:21-51`

```javascript
export function validateConversation(conversation) {
    const requiredFields = ['id', 'platform', 'title', 'messages', 'created_at'];
    for (const field of requiredFields) {
        if (!conversation[field]) {
            return { valid: false, error: `Missing required field: ${field}` };
        }
    }
    
    if (!Array.isArray(conversation.messages)) {
        return { valid: false, error: 'messages must be an array' };
    }
    
    // Validate individual messages
    for (const msg of conversation.messages) {
        if (!msg.content && msg.content !== '') {
            return { valid: false, error: 'Message missing content' };
        }
        if (!msg.role) {
            return { valid: false, error: 'Message missing role' };
        }
    }
    
    return { valid: true, error: null };
}
```

---

## Appendix A: Field Glossary

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `id` | `uuid` | Unique identifier (ULID or UUID v4) | `550e8400-e29b-41d4-a716-446655440000` |
| `user_id` | `uuid` | Foreign key to authenticated user | (same format as id) |
| `source_id` | `string` | Platform conversation ID (e.g. ChatGPT `c_abc123`) | `c_b62f7e89a92b4d3c` |
| `platform` | `string` | Origin platform enum | `'chatgpt'` |
| `messages` | `jsonb` | Array of Message objects (see 2.1.2) | `[{role: 'user', content: '...'}, ...]` |
| `content` | `text` | Formatted markdown representation | `# Title\n\nüë§ USER:\n...\n\nü§ñ ASSISTANT:\n...` |
| `folder_id` | `uuid` | Optional parent folder | `null` or valid uuid |
| `parent_id` | `uuid` | Self-reference for folder nesting | `null` (root) or valid uuid |
| `use_in_context_menu` | `boolean` | Show prompt in browser extension context menu | `true` |

---

## Appendix B: JSON Schema Examples

### B.1 Complete Chat Object (API Response)

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "folder_id": null,
  "source_id": "c_b62f7e89a92b4d3c",
  "title": "Quantum Computing Explained",
  "content": "# Quantum Computing Explained\n\nüë§ USER:\nExplain quantum computing\n\nü§ñ ASSISTANT:\nQuantum computing uses qubits...",
  "messages": [
    {
      "id": "user_msg_1",
      "role": "user",
      "content": "Explain quantum computing",
      "timestamp": 1738294800000,
      "metadata": {}
    },
    {
      "id": "asst_msg_1",
      "role": "assistant",
      "content": "Quantum computing uses qubits that can exist in superposition...",
      "timestamp": 1738294805000,
      "metadata": {
        "model": "gpt-4-turbo"
      }
    }
  ],
  "platform": "chatgpt",
  "url": "https://chatgpt.com/c/c_b62f7e89a92b4d3c",
  "summary": null,
  "tasks": null,
  "is_archived": false,
  "created_at": "2026-01-31T01:00:00.000Z",
  "updated_at": "2026-01-31T01:00:05.000Z"
}
```

---

**End of Document**  
**Last Updated**: 2026-01-31  
**Maintained By**: Superior Meta-Architect+ (Priority 1)
