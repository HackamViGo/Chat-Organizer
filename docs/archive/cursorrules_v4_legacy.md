---
trigger: always_on
---

# BrainBox ‚Äî Core Rules
**–í–µ—Ä—Å–∏—è:** 4.0.0 | **–î–∞—Ç–∞:** 2026-02-25 | **–í–∞–∂–∏ –∑–∞:** –í—Å–∏—á–∫–∏ –∞–≥–µ–Ω—Ç–∏ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏—Ü–∏

> –¢–æ–≤–∞ –µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–∏—è—Ç –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞ –ø—Ä–∞–≤–∏–ª–∞.  
> –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –¥—Ä—É–≥ —Ñ–∞–π–ª ‚Äî —Ç–æ–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç –ø–µ—á–µ–ª–∏.  
> **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** SECURITY > ARCHITECTURE > CODE > USER INSTRUCTION

---

## üî¥ –ü–†–ê–í–ò–õ–û #0 ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–Ω–∞–π-–≤–∞–∂–Ω–æ—Ç–æ)

**–°–ª–µ–¥ –≤—Å—è–∫–∞ –ø—Ä–æ–º—è–Ω–∞ –ø–æ —Ñ–∞–π–ª ‚Äî –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è—Ç–∞.**

–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ:
- –ü—Ä–æ–º—è–Ω–∞ –≤ API route ‚Üí –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π `docs/technical/SYNC_PROTOCOL.md`
- –ü—Ä–æ–º—è–Ω–∞ –≤ —Ç–∏–ø–æ–≤–µ/—Å—Ö–µ–º–∏ ‚Üí –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π `docs/technical/DATA_SCHEMA.md`  
- –ü—Ä–æ–º—è–Ω–∞ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ‚Üí –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π `docs/Mandatory!/ARCHITECTURE.md`
- –ü—Ä–æ–º—è–Ω–∞ –≤ Extension –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Üí –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π `docs/EXTENSION.md`
- –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç ‚Üí –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π `docs/technical/MONOREPO_DEPS.md`

**–î–æ–∫—É–º–µ–Ω—Ç–∏—Ç–µ –∂–∏–≤–µ—è—Ç —Å–∞–º–æ –≤ `docs/`.  
–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–æ—Ç–æ –∏–∑–∫–ª—é—á–µ–Ω–∏–µ: `README.md` —Ñ–∞–π–ª–æ–≤–µ –≤ –∫–æ—Ä–µ–Ω–∞ –Ω–∞ –ø–∞–∫–µ—Ç–∏.**

–ù–∏–∫–∞–∫–≤–∏ `.md` —Ñ–∞–π–ª–æ–≤–µ –≤ `apps/`, `packages/`, –∏–ª–∏ –∫–æ—Ä–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞  
–æ—Å–≤–µ–Ω `README.md`.

---

## üî¥ –ü–†–ê–í–ò–õ–û #1 ‚Äî Package Manager

- –°–∞–º–æ `pnpm`. –ù–∏–∫–æ–≥–∞ `npm install` –∏–ª–∏ `yarn`.
- –ê–∫–æ –Ω–∞–º–µ—Ä–∏—à `package-lock.json` ‚Üí –∏–∑—Ç—Ä–∏–π –≥–æ –∏ –¥–æ–∫–ª–∞–¥–≤–∞–π.
- –í—Å–∏—á–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ö–æ–π—Å—Ç–Ω–∞—Ç–∏ –≤ root `package.json`.

---

## üî¥ –ü–†–ê–í–ò–õ–û #2 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∏ –≥—Ä–∞–Ω–∏—Ü–∏

- `apps/extension` –Ω–∏–∫–æ–≥–∞ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞ –æ—Ç `apps/dashboard`.
- `apps/dashboard` –Ω–∏–∫–æ–≥–∞ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞ –æ—Ç `apps/extension`.
- –°–ø–æ–¥–µ–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ ‚Üí —Å–∞–º–æ –ø—Ä–µ–∑ `packages/`.
- –ù–æ–≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ–Ω —Å–ª–æ–π ‚Üí –∏–∑–∏—Å–∫–≤–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –ø—Ä–µ–¥–∏ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è.

---

## üî¥ –ü–†–ê–í–ò–õ–û #3 ‚Äî Type Safety

- `any` –µ **–∑–∞–±—Ä–∞–Ω–µ–Ω–æ**. –ò–∑–ø–æ–ª–∑–≤–∞–π `unknown` + type guards.
- `z.any()` –µ **–∑–∞–±—Ä–∞–Ω–µ–Ω–æ** –≤ Zod —Å—Ö–µ–º–∏.
- –í—Å–∏—á–∫–∏ Zod —Å—Ö–µ–º–∏ –∂–∏–≤–µ—è—Ç –≤ `@brainbox/validation/schemas/`.
- –ù–∏–∫–∞–∫–≤–∏ inline Zod —Å—Ö–µ–º–∏ –≤ API routes.
- `ignoreBuildErrors: true` –∏ `ignoreDuringBuilds: true` —Å–∞ **–∑–∞–±—Ä–∞–Ω–µ–Ω–∏** –≤ `next.config.js`.

---

## üî¥ –ü–†–ê–í–ò–õ–û #4 ‚Äî –°–∏–≥—É—Ä–Ω–æ—Å—Ç

- `user_id` –∏–¥–≤–∞ —Å–∞–º–æ –æ—Ç `auth.getUser()` server-side. –ù–∏–∫–æ–≥–∞ –æ—Ç request body.
- RLS –µ –∞–∫—Ç–∏–≤–Ω–æ –∑–∞ –≤—Å–∏—á–∫–∏ —Ç–∞–±–ª–∏—Ü–∏. –ù–∏–∫–æ–≥–∞ –Ω–µ –≥–æ –∑–∞–æ–±–∏–∫–∞–ª—è–π.
- –ù–∏–∫–∞–∫–≤–∏ hardcoded URLs ‚Äî –∏–∑–ø–æ–ª–∑–≤–∞–π `API_BASE_URL` –æ—Ç config.
- API –∫–ª—é—á–æ–≤–µ (–≤–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ `geminiApiKey`) –Ω–µ —Å–µ —Å—ä—Ö—Ä–∞–Ω—è–≤–∞—Ç –≤ `localStorage`.
- JWT —Ç–æ–∫–µ–Ω–∏ –≤ Extension —Å–µ –∫—Ä–∏–ø—Ç–∏—Ä–∞—Ç —Å AES-GCM.

---

## üî¥ –ü–†–ê–í–ò–õ–û #5 ‚Äî Logging & Debug

- –ù–∏–∫–∞–∫–≤–æ `console.log` –≤ production. –ò–∑–ø–æ–ª–∑–≤–∞–π `logger.ts`.
- `DEBUG_MODE` —Ç—Ä—è–±–≤–∞ –¥–∞ –µ `false` –ø—Ä–µ–¥–∏ –≤—Å–µ–∫–∏ commit –∫—ä–º `main`.
- –ò–∑–∫–ª—é—á–µ–Ω–∏—è: `logger.ts` –≤—ä—Ç—Ä–µ—à–Ω–æ –ø–æ–ª–∑–≤–∞ `console.*` ‚Äî –û–ö.

---

## üü° –ü–†–ê–í–ò–õ–û #6 ‚Äî State Management

- `useShallow` –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –ø—Ä–∏ Zustand –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–µ.
- Optimistic updates: snapshot ‚Üí update ‚Üí API call ‚Üí rollback –ø—Ä–∏ –≥—Ä–µ—à–∫–∞.

---

## üü° –ü–†–ê–í–ò–õ–û #7 ‚Äî Extension —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏

- –°–∞–º–æ MV3 Manifest. Service Worker, –Ω–µ background page.
- –ù–∏–∫–∞–∫—ä–≤ `localhost` –≤ production manifest ‚Äî `stripDevCSP` –µ –∞–∫—Ç–∏–≤–µ–Ω.
- `brainbox_master.js` –µ deprecated ‚Äî –Ω–µ –≥–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞–π.
- `DEBUG_MODE = true` –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ –≤ production builds.

---

## üü° –ü–†–ê–í–ò–õ–û #8 ‚Äî Git Workflow

- –ù–∏–∫–∞–∫—ä–≤ –¥–∏—Ä–µ–∫—Ç–µ–Ω push –∫—ä–º `main` (–æ—Å–≤–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–∞–Ω hotfix).
- Branches: `feature/`, `fix/`, `hotfix/`.
- Commit —Ñ–æ—Ä–º–∞—Ç: `type(scope): message` (feat, fix, refactor, docs, test, chore).
- –ü—Ä–∏ –Ω–µ—è—Å–Ω–æ—Ç–∞: —Ñ–æ—Ä–º—É–ª–∏—Ä–∞–π –≤—ä–ø—Ä–æ—Å —Å A/B –≤–∞—Ä–∏–∞–Ω—Ç–∏ –∏ **—á–∞–∫–∞–π –æ—Ç–≥–æ–≤–æ—Ä**.

---

## üü° –ü–†–ê–í–ò–õ–û #9 ‚Äî –ó–∞–±—Ä–∞–Ω–µ–Ω–∏ –ø—Ä–æ–º–µ–Ω–∏ –±–µ–∑ –æ–¥–æ–±—Ä–µ–Ω–∏–µ

- `packages/shared/src/types/` ‚Äî —Å–ø–æ–¥–µ–ª–µ–Ω–∏ —Ç–∏–ø–æ–≤–µ
- `packages/validation/schemas/` ‚Äî Zod —Å—Ö–µ–º–∏  
- `apps/extension/manifest.json` ‚Äî permissions
- `apps/dashboard/src/middleware.ts` ‚Äî auth –ª–æ–≥–∏–∫–∞
- `turbo.json` ‚Äî pipeline
- –ù–æ–≤–∏ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase

---

## üî¥ –ü–†–ê–í–ò–õ–û #10 ‚Äî Exit Protocol (—Å–∞–º–æ –∑–∞ –∞–≥–µ–Ω—Ç–∏)

–ü—Ä–∏ –ø—Ä–∏–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –∑–∞–¥–∞—á–∞, –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π –¥–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:

1. **YAML (Index)** (`agent_states/{ROLE}_state.yml`): –î–æ–±–∞–≤–∏ –Ω–æ–≤ –∑–∞–ø–∏—Å –≤ `history` —Å–∞–º–æ —Å `date` –∏ `task`.
   ```yaml
   agent: {ROLE}
   status: IDLE
   history:
     - date: "YYYY-MM-DD"
       task: "Task Name"
   ```

2. **LOG (Detail)** (`docs/agents/logs/{ROLE}_agent.log`): –î–æ–±–∞–≤–∏ –¥–µ—Ç–∞–π–ª–µ–Ω –±–ª–æ–∫:
   ```text
   Date: YYYY-MM-DD
   Task: [–ò–º–µ—Ç–æ –æ—Ç YAML]
   - –°–ø–∏—Å—ä–∫ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—è (bullet points)
   Status: SUCCESS/FAILED (—Å –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –≥—Ä–µ—à–∫–∞—Ç–∞, –∞–∫–æ –µ FAILED)
   ```

3. –ê–∫–æ –∑–∞—Å—è–≥–∞ –¥—Ä—É–≥–∞ —Ä–æ–ª—è ‚Üí append –≤ `docs/agents/logs/CHANGES.log`
4. –î–æ–∫–ª–∞–¥–≤–∞–π –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è –Ω–∞ **–±—ä–ª–≥–∞—Ä—Å–∫–∏**.

