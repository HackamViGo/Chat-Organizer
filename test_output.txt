
> @brainbox/extension@3.0.1 test:router /home/stefanov/Projects/Chat Organizer Cursor/apps/extension
> vitest --run src/background/modules/__tests__/messageRouter.test.ts


 RUN  v3.2.4 /home/stefanov/Projects/Chat Organizer Cursor/apps/extension

stdout | src/background/modules/__tests__/messageRouter.test.ts
[DEBUG] platformAdapters mock state: function

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > listen() > should register message listener
[MessageRouter] ğŸ“¡ Listening for messages... 

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > setAuthToken > should store tokens and trigger prompt sync
[MessageRouter] ğŸ“¨ Action: setAuthToken { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > setAuthToken > should handle auth errors
[MessageRouter] ğŸ“¨ Action: setAuthToken { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > checkDashboardSession > should return session validity
[MessageRouter] ğŸ“¨ Action: checkDashboardSession { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > syncAll > should sync auth and prompts
[MessageRouter] ğŸ“¨ Action: syncAll { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > fetchPrompts > should return all prompts
[MessageRouter] ğŸ“¨ Action: fetchPrompts { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > syncPrompts > should trigger prompt sync
[MessageRouter] ğŸ“¨ Action: syncPrompts { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > injectGeminiMainScript > should inject script into active tab
[MessageRouter] ğŸ“¨ Action: injectGeminiMainScript { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > injectGeminiMainScript > should handle missing tab gracefully
[MessageRouter] ğŸ“¨ Action: injectGeminiMainScript { senderId: [32m'internal'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > storeGeminiToken > should store token in storage
[MessageRouter] ğŸ“¨ Action: storeGeminiToken { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > storeGeminiToken > should store token in storage
[MessageRouter] âœ… Gemini AT token stored 

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > storeGeminiToken > should handle missing token
[MessageRouter] ğŸ“¨ Action: storeGeminiToken { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > getConversation > should fetch conversation from platform
[MessageRouter] ğŸ“¨ Action: getConversation { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should save conversation to dashboard
[MessageRouter] ğŸ“¨ Action: saveToDashboard { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should handle token expiry and trigger re-auth flow
[MessageRouter] ğŸ“¨ Action: saveToDashboard { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > getUserFolders > should fetch user folders
[MessageRouter] ğŸ“¨ Action: getUserFolders { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > openLoginPage > should open login page in new tab
[MessageRouter] ğŸ“¨ Action: openLoginPage { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

stdout | src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > Unknown action > should return false for unknown actions
[MessageRouter] ğŸ“¨ Action: unknownAction { senderId: [32m'test-extension-id'[39m, origin: [90mundefined[39m, payloadKeys: [] }

 â¯ src/background/modules/__tests__/messageRouter.test.ts (17 tests | 3 failed) 2427ms
   âœ“ MessageRouter > listen() > should register message listener 2ms
   âœ“ MessageRouter > setAuthToken > should store tokens and trigger prompt sync 52ms
   âœ“ MessageRouter > setAuthToken > should handle auth errors 52ms
   Ã— MessageRouter > checkDashboardSession > should return session validity 4ms
     â†’ this.authManager.checkAuth is not a function
   âœ“ MessageRouter > syncAll > should sync auth and prompts 51ms
   âœ“ MessageRouter > fetchPrompts > should return all prompts 52ms
   âœ“ MessageRouter > syncPrompts > should trigger prompt sync 50ms
   âœ“ MessageRouter > injectGeminiMainScript > should inject script into active tab 1ms
   âœ“ MessageRouter > injectGeminiMainScript > should handle missing tab gracefully 1ms
   âœ“ MessageRouter > storeGeminiToken > should store token in storage 51ms
   âœ“ MessageRouter > storeGeminiToken > should handle missing token 1ms
   âœ“ MessageRouter > getConversation > should fetch conversation from platform 52ms
   Ã— MessageRouter > saveToDashboard > should save conversation to dashboard 1003ms
     â†’ expected "spy" to be called with arguments: [ { id: 'conv-123', â€¦(3) }, â€¦(2) ][90m

Number of calls: [1m0[22m
[39m
   Ã— MessageRouter > saveToDashboard > should handle token expiry and trigger re-auth flow 1003ms
     â†’ expected "spy" to be called with arguments: [ ObjectContaining{â€¦} ][90m

Number of calls: [1m0[22m
[39m
   âœ“ MessageRouter > getUserFolders > should fetch user folders 52ms
   âœ“ MessageRouter > openLoginPage > should open login page in new tab 1ms
   âœ“ MessageRouter > Unknown action > should return false for unknown actions 1ms

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 3 â¯â¯â¯â¯â¯â¯â¯

 FAIL  src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > checkDashboardSession > should return session validity
TypeError: this.authManager.checkAuth is not a function
 â¯ MessageRouter.handleCheckSession src/background/modules/messageRouter.ts:158:26
    156| 
    157|     private handleCheckSession(sendResponse: Function): boolean {
    158|         this.authManager.checkAuth()
       |                          ^
    159|             .then(isValid => sendResponse({ success: true, isValid }))
    160|             .catch(error => sendResponse({ success: false, error: erroâ€¦
 â¯ MessageRouter.handleMessage src/background/modules/messageRouter.ts:91:29
 â¯ src/background/modules/__tests__/messageRouter.test.ts:157:30

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/3]â¯

 FAIL  src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should save conversation to dashboard
AssertionError: expected "spy" to be called with arguments: [ { id: 'conv-123', â€¦(3) }, â€¦(2) ][90m

Number of calls: [1m0[22m
[39m
 â¯ src/background/modules/__tests__/messageRouter.test.ts:335:46
    333| 
    334|       await vi.waitFor(() => {
    335|         expect(dashboardApi.saveToDashboard).toHaveBeenCalledWith(
       |                                              ^
    336|           request.data,
    337|           'folder-1',

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/3]â¯

 FAIL  src/background/modules/__tests__/messageRouter.test.ts > MessageRouter > saveToDashboard > should handle token expiry and trigger re-auth flow
AssertionError: expected "spy" to be called with arguments: [ ObjectContaining{â€¦} ][90m

Number of calls: [1m0[22m
[39m
 â¯ src/background/modules/__tests__/messageRouter.test.ts:358:30
    356| 
    357|       await vi.waitFor(() => {
    358|         expect(sendResponse).toHaveBeenCalledWith(expect.objectContainâ€¦
       |                              ^
    359|           success: false,
    360|           error: 'Unauthorized'

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/3]â¯

â¯â¯â¯â¯â¯â¯ Unhandled Errors â¯â¯â¯â¯â¯â¯

Vitest caught 2 unhandled errors during the test run.
This might cause false positive tests. Resolve unhandled errors to make sure your tests are not affected.

â¯â¯â¯â¯ Unhandled Rejection â¯â¯â¯â¯â¯
TypeError: this.authManager.checkAuth is not a function
 â¯ MessageRouter.ensureActiveSession src/background/modules/messageRouter.ts:256:48
    254| 
    255|     private async ensureActiveSession(): Promise<boolean> {
    256|         const isValid = await this.authManager.checkAuth();
       |                                                ^
    257|         if (isValid) return true;
    258| 
 â¯ MessageRouter.performSaveConversation src/background/modules/messageRouter.ts:291:42
 â¯ MessageRouter.handleSaveConversation src/background/modules/messageRouter.ts:286:14
 â¯ MessageRouter.handleMessage src/background/modules/messageRouter.ts:127:29
 â¯ src/background/modules/__tests__/messageRouter.test.ts:332:30
 â¯ ../../../Chat%20Organizer%20Cursor/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

This error originated in "src/background/modules/__tests__/messageRouter.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should save conversation to dashboard". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.

â¯â¯â¯â¯ Unhandled Rejection â¯â¯â¯â¯â¯
TypeError: this.authManager.checkAuth is not a function
 â¯ MessageRouter.ensureActiveSession src/background/modules/messageRouter.ts:256:48
    254| 
    255|     private async ensureActiveSession(): Promise<boolean> {
    256|         const isValid = await this.authManager.checkAuth();
       |                                                ^
    257|         if (isValid) return true;
    258| 
 â¯ MessageRouter.performSaveConversation src/background/modules/messageRouter.ts:291:42
 â¯ MessageRouter.handleSaveConversation src/background/modules/messageRouter.ts:286:14
 â¯ MessageRouter.handleMessage src/background/modules/messageRouter.ts:127:29
 â¯ src/background/modules/__tests__/messageRouter.test.ts:355:30
 â¯ ../../../Chat%20Organizer%20Cursor/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
 â¯ ../../../Chat%20Organizer%20Cursor/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
 â¯ ../../../Chat%20Organizer%20Cursor/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
 â¯ runWithTimeout ../../../Chat%20Organizer%20Cursor/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10

This error originated in "src/background/modules/__tests__/messageRouter.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "should handle token expiry and trigger re-auth flow". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯


 Test Files  1 failed (1)
      Tests  3 failed | 14 passed (17)
     Errors  2 errors
   Start at  01:13:42
   Duration  3.29s (transform 72ms, setup 33ms, collect 51ms, tests 2.43s, environment 320ms, prepare 176ms)

/home/stefanov/Projects/Chat Organizer Cursor/apps/extension:
â€‰ERR_PNPM_RECURSIVE_RUN_FIRST_FAILâ€‰ @brainbox/extension@3.0.1 test:router: `vitest --run src/background/modules/__tests__/messageRouter.test.ts`
Exit status 1
