# AI_AGENT_RULES.md

> **Версия:** 1.0  
> **Важи за:** Cursor, Windsurf, Claude.ai (директно), Custom AI агенти  
> **Статус:** Договор. Агентът потвърждава, че го е прочел преди да започне работа.

---

## Преди да пишеш каквото и да е

Прочети в този ред:

1. `PRODUCT.md` — какво е продуктът, за кого е, какво НЕ прави
2. `ARCHITECTURE.md` — как са наредени слоевете, кой комуникира с кого
3. `CODE_GUIDELINES.md` — как се пише код в този проект
4. `SECURITY.md` — какво е задължително за сигурността
5. `CONTEXT_MAP.md` — кой файл кой слой owns

Ако не си прочел тези пет файла — не пишеш код.

---

## Правила без изключения

### Архитектура

**1. Не добавяш нов слой без одобрение.**  
Ако смяташ, че е нужен нов service, нов state manager, нова библиотека или нова комуникационна пътека — спри. Напиши предложение с обосновка. Чакай потвърждение. После го добавяй.

**2. Не импровизираш архитектура.**  
Структурата е описана в `ARCHITECTURE.md`. Следваш я. Ако не е ясно как нещо се вписва — питаш, не предполагаш.

**3. Extension и Dashboard са изолирани.**  
Extension не импортира от `apps/dashboard`. Dashboard не знае за имплементацията на Extension. Комуникацията е само HTTP API. Без изключения.

**4. Не създаваш дублираща логика.**  
Преди да напишеш utility функция — провери дали вече съществува в `@brainbox/shared`. Преди да напишеш тип — провери `@brainbox/shared/src/types/`. Преди да напишеш Zod schema — провери `@brainbox/validation`.

**5. Всички типове са централизирани.**  
Нов споделен тип → `packages/shared/src/types/index.ts`.  
Нова Zod schema → `packages/validation/schemas/`.  
Никога inline type definitions за споделени обекти.

### Код

**6. `any` е забранено.**  
Ако не знаеш типа — питай. Ако типът е наистина динамичен — използвай `unknown` и type guard. Никога `any`.

**7. `console.log` е забранено в production код.**  
Използвай `logger.ts`. В Extension: `import { logger } from '@/lib/logger'`. В Dashboard: `import { logger } from '@/lib/logger'`.

**8. Всички входящи данни минават през Zod.**  
API route body, Extension sync data, URL параметри — всичко. Преди да пишеш DB операция — пиши Zod validation.

**9. `user_id` идва само от `auth.getUser()` server-side.**  
Никога от request body, никога от client-side state, никога hardcoded.

**10. Optimistic updates имат rollback.**  
Ако пишеш Zustand action с API call — snapshot преди мутацията, rollback при грешка. Без изключения.

### Процес

**11. Нова функционалност изисква попълнен `FEATURE_TEMPLATE.md`.**  
Не пишеш код без шаблон. Ако потребителят не е предоставил шаблон — генерираш го ти и питаш за потвърждение.

**12. Ако нещо не е ясно — питаш.**  
Не предполагаш. Не избираш "по-лесното" решение. Пишеш конкретен въпрос: "Не ми е ясно X. Имам две опции: A или B. Коя предпочиташ?"

**13. Никога директен push към `main`.**  
Всяка промяна е в `feature/*` или `fix/*` branch. Всичко минава през PR.

---

## Какво правиш при задача

### Стандартен flow

```
1. Прочети задачата изцяло
2. Провери FEATURE_TEMPLATE.md (съществува ли за тази задача?)
3. Идентифицирай засегнатите файлове (CONTEXT_MAP.md)
4. Провери CODE_GUIDELINES.md за съответните секции
5. Провери SECURITY.md ако задачата засяга auth, data, API routes
6. Напиши плана в 3-5 стъпки и изчакай потвърждение
7. Изпълни стъпките последователно
8. Провери дали резултатът отговаря на FEATURE_TEMPLATE.md §8 (Definition of Done)
```

### При неяснота

Напиши точно:
> "Не ми е ясно [конкретното нещо]. Намерих [брой] опции:  
> A) [описание] — предимство X, недостатък Y  
> B) [описание] — предимство X, недостатък Y  
> Какво предпочиташ?"

Не избирай сам. Не правиш предположения. Питаш.

### При конфликт между правила

Приоритетен ред:
1. `SECURITY.md` — най-висок приоритет
2. `ARCHITECTURE.md` — архитектурни граници
3. `CODE_GUIDELINES.md` — code quality
4. `FEATURE_TEMPLATE.md` — feature completeness
5. Изричната инструкция на потребителя

Ако инструкцията на потребителя нарушава `SECURITY.md` — не я изпълняваш. Обясняваш защо и предлагаш алтернатива.

---

## Забранени действия

Никога не правиш следното без изричен approval:

- Промяна в `packages/shared/src/types/` (засяга целия monorepo)
- Промяна в `packages/validation/schemas/` (засяга всички API contracts)
- Промяна в `apps/extension/manifest.json` permissions
- Промяна в `apps/dashboard/src/middleware.ts` auth logic
- Добавяне на нова external библиотека
- Промяна в Supabase RLS политики
- Промяна в `turbo.json` pipeline
- Преименуване или преместване на файлове (засяга imports навсякъде)

При искане за такава промяна — описваш промяната, обосноваваш я, чакаш потвърждение.

---

## Какво докладваш при приключване

При всяка завършена задача докладваш:

```
## Готово

**Промени:**
- [файл] — [какво е направено]
- [файл] — [какво е направено]

**Тестове:**
- [какво е тествано, как]

**Необходими следващи стъпки:**
- [ако има нещо, което не е направено]

**Потенциални рискове:**
- [ако има нещо, за което да внимаваш]
```

---

## Solo Workflow — специфики

Тъй като проектът е solo, няма втори човек за code review. Това означава:

- **PR review-то се прави от агента.** При всеки PR агентът проверява промените спрямо `CODE_GUIDELINES.md` и `SECURITY.md` и докладва аномалии преди merge.
- **Feature template-ът е задължителен дори solo.** Не е за екипна координация — е за да не забравяш edge cases и security когато пишеш бързо.
- **Агентът не merge-ва автоматично.** Дори ако CI минава — финалното "merge" решение е твое.
- **При hotfix:** Допустим е директен push към `main` само ако `pre-push` hook е временно disabled с `git push --no-verify`. Документирай причината в commit message: `hotfix(extension): emergency auth fix — bypassed hooks due to critical prod issue`.

> Бележка: Ако смениш IDE в бъдеще, актуализирай само тази секция — останалите правила важат за всеки агент.

- Постави тези файлове в root на проекта: `PRODUCT.md`, `ARCHITECTURE.md`, `CODE_GUIDELINES.md`, `SECURITY.md` — Antigravity ги чете автоматично като контекст
- При всяка нова сесия потвърди, че агентът е прочел поне `ARCHITECTURE.md` и `CODE_GUIDELINES.md` преди да даваш задачи
- Ако агентът предложи нещо, което противоречи на документите — цитирай конкретното правило, не го убеждавай с аргументи
- При смяна на IDE: провери дали новият инструмент поддържа `.rules` или `system prompt` файл и прехвърли съдържанието на `AI_AGENT_RULES.md` там
