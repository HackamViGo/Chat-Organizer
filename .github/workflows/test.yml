name: Test Suite

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/extension/**'
      - 'packages/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/extension/**'
      - 'packages/**'
  workflow_dispatch:

jobs:
  test:
    name: Unit Tests (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    strategy:
      matrix:
        node: [18, 20]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ğŸŸ¢ Setup Node ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'pnpm'

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Lint
        run: pnpm lint

      - name: ğŸ”§ Type check
        run: pnpm type-check

      - name: ğŸ§ª Run all tests
        run: pnpm test:all --run

      - name: ğŸ“Š Generate coverage
        run: pnpm test:coverage

      - name: ğŸ“¤ Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/extension/coverage/coverage-final.json
          flags: node-${{ matrix.node }}

      - name: ğŸ’¾ Archive results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ matrix.node }}
          path: |
            apps/extension/coverage/
            apps/extension/test-results/

  test-auth:
    name: Auth Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm test authManager.test.ts --run
      - run: pnpm test authManagerExtended.test.ts --run

  test-platforms:
    name: Platform Tests (${{ matrix.platform }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        platform:
          - deepseek
          - perplexity
          - grok
          - qwen
          - lmarena
          - chatgpt
          - claude
          - gemini
    
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm test ${{ matrix.platform }}.test.ts --run

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-auth, test-platforms]
    
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm test integration.test.ts --run
      - run: pnpm test newPlatforms.integration.test.ts --run

  coverage-check:
    name: Coverage Threshold
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:coverage
      
      - name: Check thresholds
        run: |
          LINES=$(jq '.total.lines.pct' apps/extension/coverage/coverage-summary.json)
          BRANCHES=$(jq '.total.branches.pct' apps/extension/coverage/coverage-summary.json)
          FUNCTIONS=$(jq '.total.functions.pct' apps/extension/coverage/coverage-summary.json)
          
          echo "ğŸ“Š Coverage:"
          echo "  Lines: $LINES%"
          echo "  Branches: $BRANCHES%"
          echo "  Functions: $FUNCTIONS%"
          
          if (( $(echo "$LINES < 85" | bc -l) )); then
            echo "âŒ Line coverage below 85%"
            exit 1
          fi
          
          if (( $(echo "$BRANCHES < 80" | bc -l) )); then
            echo "âŒ Branch coverage below 80%"
            exit 1
          fi
          
          echo "âœ… Coverage meets thresholds"

  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm build:extension
      
      - name: Check build artifacts
        run: |
          if [ ! -d "apps/extension/dist" ]; then
            echo "âŒ Build failed - dist directory not created"
            exit 1
          fi
          
          if [ ! -f "apps/extension/dist/manifest.json" ]; then
            echo "âŒ manifest.json not found in dist"
            exit 1
          fi
          
          echo "âœ… Build successful"

  status:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [test, test-auth, test-platforms, test-integration, coverage-check, build-check]
    if: always()
    
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "âŒ Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.test-auth.result }}" != "success" ]; then
            echo "âŒ Auth tests failed"
            exit 1
          fi
          if [ "${{ needs.test-platforms.result }}" != "success" ]; then
            echo "âŒ Platform tests failed"
            exit 1
          fi
          if [ "${{ needs.test-integration.result }}" != "success" ]; then
            echo "âŒ Integration tests failed"
            exit 1
          fi
          if [ "${{ needs.coverage-check.result }}" != "success" ]; then
            echo "âŒ Coverage check failed"
            exit 1
          fi
          if [ "${{ needs.build-check.result }}" != "success" ]; then
            echo "âŒ Build check failed"
            exit 1
          fi
          
          echo "âœ… All checks passed!"
